{% extends "base.html" %}
{% block title %}Auftrag anlegen{% endblock %}

{% block content %}
<h2>Neuen Auftrag anlegen</h2>

<form action="/auftraege" method="post">

  <!-- Datalists für Vorschläge -->
  <datalist id="einheiten">
    <option value="Stück">
    <option value="Liter">
    <option value="m²">
    <option value="m³">
    <option value="kg">
    <option value="Meter">
    <option value="Paket">
    <option value="Rolle">
    <option value="Sack">
    <option value="Eimer">
  </datalist>

  <datalist id="mengen">
    <option value="1">
    <option value="2">
    <option value="3">
    <option value="4">
    <option value="5">
    <option value="10">
    <option value="15">r
    <option value="20">
    <option value="25">
    <option value="50">
    <option value="100">
  </datalist>

  <datalist id="preise">
    <option value="0.50">
    <option value="1.00">
    <option value="2.50">
    <option value="5.00">
    <option value="7.50">
    <option value="10.00">
    <option value="12.50">
    <option value="15.00">
    <option value="20.00">
    <option value="25.00">
    <option value="30.00">
    <option value="35.00">
    <option value="40.00">
    <option value="45.00">
    <option value="50.00">
    <option value="75.00">
    <option value="100.00">
  </datalist>

  <datalist id="stunden">
    <option value="0.25">
    <option value="0.5">
    <option value="0.75">
    <option value="1">
    <option value="1.5">
    <option value="2">
    <option value="2.5">
    <option value="3">
    <option value="4">
    <option value="5">
    <option value="6">
    <option value="7">
    <option value="8">
    <option value="10">
    <option value="12">
  </datalist>

  <datalist id="stundenlohn">
    <option value="25.00">
    <option value="30.00">
    <option value="35.00">
    <option value="40.00">
    <option value="45.00">
    <option value="50.00">
    <option value="55.00">
    <option value="60.00">
    <option value="65.00">
    <option value="70.00">
    <option value="75.00">
    <option value="80.00">
  </datalist>

  <label for="kunde">Kunde auswählen:</label>
  <select name="kunde_id" id="kunde" required>
    {% for kunde in kunden %}
    <option value="{{ kunde.id }}">
      {% if kunde.kundenart == "Privatkunde" %}
      {{ kunde.kunde_nachname }} {{ kunde.kunde_vorname }}
      {% else %}
      {{ kunde.ansprechpartner_nachname }} {{ kunde.ansprechpartner_vorname }}
      {% endif %}
      {% if kunde.kunde_firmenname %} – {{ kunde.kunde_firmenname }}{% endif %}
    </option>
    {% endfor %}
  </select>

  <label for="beschreibung">Auftragsbeschreibung:</label>
  <input type="text" name="auftragsbeschreibung" id="beschreibung" required>

  <fieldset>
    <legend>Leistungsadresse</legend>
    <label for="kunde_leistungsadresse">Adresse:</label>
    <input type="text" name="kunde_leistungsadresse" id="kunde_leistungsadresse" required>
    <label for="kunde_leistung_plz">PLZ:</label>
    <input type="text" name="kunde_leistung_plz" id="kunde_leistung_plz" required>
    <label for="kunde_leistung_ort">Ort:</label>
    <input type="text" name="kunde_leistung_ort" id="kunde_leistung_ort" required>
    <button type="button" class="btn btn-secondary btn-sm" onclick="adresseVonKundeLaden()">
      Rechnungsadresse übernehmen
    </button>
  </fieldset>

  <!-- Arbeitseinheiten -->
  <div id="komponenten-container">
    <div class="arbeit-komponente">
      <h4>Arbeitseinheit</h4>
      <label>Startdatum:</label>
      <input type="date" name="komponente_start[]" required>
      <label>Enddatum:</label>
      <input type="date" name="komponente_ende[]" required>
      <label>Tätigkeit:</label>
      <input type="text" name="arbeit[]" required>

      <label>Berechnungsbasis:</label>
      <select name="berechnungsbasis[]" onchange="toggleCalculationFields(this)" required>
        <option value="">-- Bitte wählen --</option>
        <option value="stunden">Nach Stunden</option>
        <option value="quadratmeter">Nach Quadratmetern</option>
      </select>

      <fieldset class="calculation-fields stunden-fields" style="display: none;">
        <legend>Stundenbasierte Abrechnung</legend>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <label>Stunden:</label>
            <input list="stunden" type="number" step="0.25" min="0.25" name="anzahl_stunden[]"
              placeholder="z.B. 8,5 oder 8.5">
          </div>
          <div>
            <label>Stundenlohn (€):</label>
            <input list="stundenlohn" type="number" step="0.01" min="1" name="stundenlohn[]"
              placeholder="z.B. 50,00 oder 50.00">
          </div>
        </div>
      </fieldset>

      <fieldset class="calculation-fields quadratmeter-fields" style="display: none;">
        <legend>Flächenbasierte Abrechnung</legend>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <label>Quadratmeter:</label>
            <input type="number" step="0.01" min="0.01" name="anzahl_quadrat[]" placeholder="z.B. 25,5 oder 25.5">
          </div>
          <div>
            <label>Preis pro Quadratmeter (€):</label>
            <input type="number" step="0.01" min="0.01" name="preis_pro_quadrat[]" placeholder="z.B. 15,00 oder 15.00">
          </div>
        </div>
      </fieldset>

      <label>Beschreibung:</label>
      <textarea name="beschreibung_liste[]"></textarea>
      <button type="button" class="btn btn-danger btn-sm" onclick="removeKomponente(this)">Entfernen</button>
    </div>
  </div>
  <button type="button" class="btn btn-secondary" onclick="addKomponente()">+ Arbeitseinheit hinzufügen</button>

  <hr>

  <!-- Material-Komponenten (Optional) -->
  <h4>Material <em>(Optional)</em></h4>
  <div id="material-container">
    <!-- Kein Standard-Material-Eintrag mehr -->
  </div>
  <button type="button" class="btn btn-secondary" onclick="addMaterial()">+ Material hinzufügen</button>

  <br><br>
  <button type="submit" class="btn btn-success">Auftrag speichern</button>
</form>

<!-- BuildFlow Workflow Navigation -->
<div class="workflow-navigation">
  <h3>Nächster Schritt im BuildFlow</h3>
  <div class="next-step-card">
    <div class="step-info">
      <div class="step-number">3</div>
      <div class="step-details">
        <h4>Rechnung erstellen</h4>
        <p>Generieren Sie jetzt eine Rechnung aus diesem Auftrag</p>
      </div>
    </div>
    <a href="/rechnung" class="workflow-btn">
      <span>→ Rechnung erstellen</span>
    </a>
  </div>

  <div class="workflow-overview">
    <span>Workflow: </span>
    <span class="completed">✓ Kunde anlegen</span>
    <span class="completed">✓ Auftrag erstellen</span>
    <span class="next">→ Rechnung generieren</span>
    <span class="pending">→ Rechnung als bezahlt markieren</span>
    <span class="pending">→ Buchhaltung</span>
  </div>
</div>


<script>
  function toggleCalculationFields(selectElement) {
    const parent = selectElement.closest('.arbeit-komponente');
    const stundenFields = parent.querySelector('.stunden-fields');
    const quadratFields = parent.querySelector('.quadratmeter-fields');
    const stundenInputs = stundenFields.querySelectorAll('input');
    const quadratInputs = quadratFields.querySelectorAll('input');

    if (selectElement.value === 'stunden') {
      stundenFields.style.display = 'block';
      quadratFields.style.display = 'none';
      stundenInputs.forEach(input => input.required = true);
      quadratInputs.forEach(input => { input.required = false; input.value = ''; });
    } else if (selectElement.value === 'quadratmeter') {
      stundenFields.style.display = 'none';
      quadratFields.style.display = 'block';
      quadratInputs.forEach(input => input.required = true);
      stundenInputs.forEach(input => { input.required = false; input.value = ''; });
    } else {
      stundenFields.style.display = 'none';
      quadratFields.style.display = 'none';
      stundenInputs.forEach(input => { input.required = false; input.value = ''; });
      quadratInputs.forEach(input => { input.required = false; input.value = ''; });
    }
  }

  function addKomponente() {
    try {
      console.log("addKomponente called");
      const container = document.getElementById("komponenten-container");
      if (!container) {
        console.error("Container not found");
        return;
      }

      let original = container.querySelector(".arbeit-komponente");

      if (!original) {
        // No existing component, create from scratch
        console.log("No existing component found, creating new one from scratch");
        original = createEmptyKomponente();
        container.appendChild(original);
        console.log("First component created successfully");
        return;
      }

      console.log("Cloning existing component...");
      const clone = original.cloneNode(true);

      // Clear all form values
      clone.querySelectorAll("input, textarea, select").forEach(el => {
        el.value = "";
        if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        }
      });

      // Hide all calculation fields in new component
      clone.querySelectorAll('.calculation-fields').forEach(field => field.style.display = 'none');
      clone.querySelectorAll('.calculation-fields input').forEach(input => input.required = false);

      container.appendChild(clone);
      console.log("Component added successfully");
    } catch (error) {
      console.error("Error in addKomponente:", error);
      alert("Fehler beim Hinzufügen der Arbeitseinheit: " + error.message);
    }
  }

  function createEmptyKomponente() {
    const komponente = document.createElement("div");
    komponente.className = "arbeit-komponente";
    komponente.innerHTML =
      '<h4>Arbeitseinheit</h4>' +
      '<label>Startdatum:</label>' +
      '<input type="date" name="komponente_start[]" required>' +
      '<label>Enddatum:</label>' +
      '<input type="date" name="komponente_ende[]" required>' +
      '<label>Tätigkeit:</label>' +
      '<input type="text" name="arbeit[]" required>' +
      '<label>Berechnungsbasis:</label>' +
      '<select name="berechnungsbasis[]" onchange="toggleCalculationFields(this)" required>' +
      '<option value="">-- Bitte wählen --</option>' +
      '<option value="stunden">Nach Stunden</option>' +
      '<option value="quadratmeter">Nach Quadratmetern</option>' +
      '</select>' +
      '<fieldset class="calculation-fields stunden-fields" style="display: none;">' +
      '<legend>Stundenbasierte Abrechnung</legend>' +
      '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">' +
      '<div>' +
      '<label>Stunden:</label>' +
      '<input list="stunden" type="number" step="0.25" min="0.25" name="anzahl_stunden[]" placeholder="z.B. 8,5 oder 8.5">' +
      '</div>' +
      '<div>' +
      '<label>Stundenlohn (€):</label>' +
      '<input list="stundenlohn" type="number" step="0.01" min="1" name="stundenlohn[]" placeholder="z.B. 50,00 oder 50.00">' +
      '</div>' +
      '</div>' +
      '</fieldset>' +
      '<fieldset class="calculation-fields quadratmeter-fields" style="display: none;">' +
      '<legend>Flächenbasierte Abrechnung</legend>' +
      '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">' +
      '<div>' +
      '<label>Quadratmeter:</label>' +
      '<input type="number" step="0.01" min="0.01" name="anzahl_quadrat[]" placeholder="z.B. 25,5 oder 25.5">' +
      '</div>' +
      '<div>' +
      '<label>Preis pro Quadratmeter (€):</label>' +
      '<input type="number" step="0.01" min="0.01" name="preis_pro_quadrat[]" placeholder="z.B. 15,00 oder 15.00">' +
      '</div>' +
      '</div>' +
      '</fieldset>' +
      '<label>Beschreibung:</label>' +
      '<textarea name="beschreibung_liste[]"></textarea>' +
      '<button type="button" class="btn btn-danger btn-sm" onclick="removeKomponente(this)">Entfernen</button>';
    return komponente;
  }

  function removeKomponente(button) {
    const container = document.getElementById("komponenten-container");
    const komponenten = container.querySelectorAll(".arbeit-komponente");

    if (komponenten.length <= 1) {
      alert("Mindestens eine Arbeitseinheit muss vorhanden sein.");
      return;
    }

    button.parentElement.remove();
  }
  function addMaterial() {
    const container = document.getElementById("material-container");
    const newMaterial = document.createElement("div");
    newMaterial.className = "material-komponente";
    newMaterial.innerHTML = `
    <h4>Material-Komponente</h4>
    <label>Bezeichnung:</label>
    <input type="text" name="material_bezeichnung[]">
    
    <label>Berechnungseinheit:</label>
    <input list="einheiten" type="text" name="material_berechnungseinheit[]" placeholder="z.B. Liter, m², Stück">
    
    <label>Anzahl:</label>
    <input list="mengen" type="number" step="0.1" min="0.1" name="material_anzahl[]" placeholder="1,0">
    
    <label>Preis pro Einheit (€):</label>
    <input list="preise" type="number" step="0.01" min="0.01" name="material_preis_pro_einheit[]" placeholder="z.B. 4,50 oder 4.50">
    
    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()">Entfernen</button>
  `;
    container.appendChild(newMaterial);
  }
  function adresseVonKundeLaden() {
    const kundeId = document.getElementById("kunde").value;
    if (!kundeId) { alert("Bitte zuerst einen Kunden auswählen."); return; }
    fetch(`/api/kunde/${kundeId}`)
      .then(r => { if (!r.ok) throw new Error("Fehler beim Laden"); return r.json(); })
      .then(d => {
        document.getElementById("kunde_leistungsadresse").value = d.kunde_rechnungsadresse || '';
        document.getElementById("kunde_leistung_plz").value = d.kunde_rechnung_plz || '';
        document.getElementById("kunde_leistung_ort").value = d.kunde_rechnung_ort || '';
      })
      .catch(() => alert("Kundendaten konnten nicht geladen werden."));
  }
</script>
{% endblock %}